var redis = require('redis').createClient();

var randomWord = function(callback) {
  redis.randomkey(function(result, key) {
    //console.log('randomWord', result, key);
    callback(key);
  });
}

var nextWord = function(word, callback) {
  redis.exists(word, function(err, data) {
    if (data == null) return callback(null);

    redis.hgetall(word, function(result, data) {
      var sum = 0;
      for (var i in data) {
      	sum += data[i];
      }
      var rand = Math.floor(Math.random()*sum+1);
      var partial_sum = 0;
      var next = null;
      for (var i in data) {
        partial_sum += data[i];
        if (partial_sum >= rand) { next = i; }
      }
      callback(next);
    });
  });
}

var randomSentance = function(options, callback, word) {
  var sentance = [];
  randomWord( function(word) {
    function build(next) {
      sentance.push(!next || sentance.length > 15 ? '.' : ' ' + next);
      
      if (sentance.length > 5 && /(\.|!|\?)/.exec(sentance)) {
				callback(null, sentance.join(''));
      } else {
				nextWord(next, build);
			}
    }
    build(word);
  });
}

module.exports = {
	randomSentance: randomSentance
}